# 执行上下文

## 执行上下文的概念

执行上下文是当前 JavaScript 代码被解析和执行时所在环境的抽象概念。

> 粗暴的理解：执行上下文就是 JS 代码执行的环境。

## 执行上下文的类型

1. 全局执行上下文
   > 只有一个，浏览器中的全局对象就是 window 对象，this 指向这个全局对象。
2. 函数执行上下文
   > 存在无数个，只有在函数被调用的时候才会被创建，每次调用函数都会创建一个新的执行上下文。
3. `Eval` 函数执行上下文
   > 指的是运行在 `eval` 函数中的代码，很少用而且不建议使用

## 执行上下文栈

- 执行上下文栈，用来存储代码执行期间创建的所有执行上下文的 **栈结构**。
  > 栈结构，就是一个数组，但是只能从尾部操作，然后出栈的时候，后进先出的逻辑。

## 执行上下文的创建

1. 创建阶段
2. 执行阶段

### 1.1 确定 `this`；

#### 1.1.1 全局执行上下文

- `this` 的值指向全局对象，在浏览器中 `this` 的值指向 `window` 对象，而在 nodejs 中指向这个文件的 `module` 对象。

#### 1.1.2 函数执行上下文

- `this` 指向没啥好说的，五种情况。
- 但是需要注意，执行上下文，是 JS 代码执行的时候创建的。就比如我一个函数调用两次，那么就会创建两个执行上下文来对应这两次调用。
- 与之相关的 `this` 指向，和函数调用的方式有关。

### 1.2 初始化 `LexicalEnvironment`（词法环境）；

- 环境记录（存储变量和函数声明的实际位置）
- 对外部环境的引用（访问外部词法环境）

#### 1.2.1 全局执行上下文

- 拥有一个全局对象（window 对象）及其关联的方法和属性（例如数组方法）以及任何用户自定义的全局变量，this 的值指向这个全局对象。
- 没有外部环境，其外部环境引用为 null。

#### 1.2.2 函数执行上下文

- 用户在函数中定义的变量被存储在环境记录中，包含了 arguments 对象
- 对外部环境的引用

### 1.3 初始化 `VariableEnvironment`（变量环境）；

类似 词法环境，

在 ES6 中，词法 环境和 变量 环境的区别在于前者用于存储**函数声明和变量（ let 和 const ）绑定，而后者仅用于存储变量（ var ）**绑定。

2. 执行阶段
   此阶段，完成对所有变量的分配，最后执行代码。

## 换一种角度思考

执行上下文可以理解为 一个对象

- 变量对象(Variable object，VO)
- 作用域链(Scope chain)
- this

全局的变量对象

1. window （全局上下文的变量对象初始化是全局对象）

函数的变量对象

1. 函数上下文的变量对象初始化只包括 Arguments 对象；
2. 在进入执行上下文时会给变量对象添加形参、函数声明、变量声明等初始的属性值；
3. 在代码执行阶段，会再次修改变量对象的属性值；
